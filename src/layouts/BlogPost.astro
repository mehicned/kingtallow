---
import { Image } from 'astro:assets';
import type { CollectionEntry } from 'astro:content';
import type { ImageMetadata } from 'astro';
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';
import FormattedDate from '../components/FormattedDate.astro';
import Header from '../components/Header.astro';
import { Badge } from '../components/ui/badge';
import { Button } from '../components/ui/button';
import { SITE_URL } from '../consts';

type Props = CollectionEntry<'blog'>['data'];

const { title, description, pubDate, updatedDate, heroImage, author, focusKeyphrase, keywords } = Astro.props;

// Import all images from assets
const images = import.meta.glob<{ default: ImageMetadata }>('../assets/*.{png,jpg,jpeg,webp}', { eager: true });

const getImagePath = (path: string) => {
	if (!path) return null;
	const imageName = path.split('/').pop();
	const imagePath = `../assets/${imageName}`;
	return images[imagePath]?.default;
};

const heroSrc = getImagePath(heroImage);

// Get the current URL path for the blog post
const currentPath = Astro.url.pathname;

// Schema.org JSON-LD for BlogPosting
const schemaOrgBlogPosting = {
	'@context': 'https://schema.org',
	'@type': 'BlogPosting',
	headline: title,
	description: description,
	image: heroImage ? `${SITE_URL}${heroImage}` : `${SITE_URL}/king.png`,
	datePublished: pubDate.toISOString(),
	dateModified: updatedDate ? updatedDate.toISOString() : pubDate.toISOString(),
	author: {
		'@type': 'Person',
		name: author?.name ?? 'Miles Carter',
	},
	publisher: {
		'@type': 'Organization',
		name: 'King Tallow',
		logo: {
			'@type': 'ImageObject',
			url: `${SITE_URL}/king.png`,
		},
	},
	mainEntityOfPage: {
		'@type': 'WebPage',
		'@id': `${SITE_URL}${currentPath}`,
	},
	keywords: keywords?.join(', ') ?? focusKeyphrase,
};
---

<html lang="en">
	<head>
		<BaseHead title={title} description={description} />
		<!-- BlogPosting Schema -->
		<script type="application/ld+json" set:html={JSON.stringify(schemaOrgBlogPosting)} />
	</head>

	<body>
		<Header />
		<main class="pb-20">
			<section class="section-shell">
				<div class="surface-card space-y-8 overflow-hidden border p-6 shadow-soft md:p-8">
					<div class="space-y-3">
						<Badge className="w-fit" variant="sunlit">Resource</Badge>
						<h1 class="text-4xl font-display leading-tight text-foreground md:text-5xl">{title}</h1>
						<div class="flex flex-wrap items-center gap-3 text-sm text-muted-foreground">
							<span class="inline-flex items-center gap-2">
								<span class="h-2 w-2 rounded-full bg-primary"></span>
								Published <FormattedDate date={pubDate} />
							</span>
							{
								updatedDate && (
									<span class="inline-flex items-center gap-2">
										<span class="h-2 w-2 rounded-full bg-secondary"></span>
										Updated <FormattedDate date={updatedDate} />
									</span>
								)
							}
							<span class="inline-flex items-center gap-2 text-foreground">
								<span class="h-2 w-2 rounded-full bg-primary/50"></span>
								{Astro.props.author?.name ?? 'Miles Carter'}
							</span>
						</div>
					</div>

					{
						heroSrc && (
							<div class="overflow-hidden rounded-3xl border border-border/70 bg-card/80">
								<Image
									class="h-full w-full object-cover"
									src={heroSrc}
									alt={title}
									width={1200}
									height={675}
									format="webp"
									quality={85}
									loading="eager"
									decoding="async"
								/>
							</div>
						)
					}

					<article class="prose-styled">
						<slot />
					</article>

					<div class="flex flex-wrap items-center justify-between gap-3 border-t border-border/70 pt-6">
						<div class="space-y-1">
							<p class="text-sm font-semibold uppercase tracking-[0.18em] text-muted-foreground">
								Need more detail?
							</p>
							<p class="text-muted-foreground">
								Send questions to
								<a class="ml-1 font-semibold text-primary hover:text-secondary" href="mailto:contact@kingtallow.com">
									contact@kingtallow.com
								</a>
								and weâ€™ll add clarifications.
							</p>
						</div>
						<div class="flex gap-3">
							<Button variant="outline" asChild>
								<a href="/resources">Back to all resources</a>
							</Button>
							<Button asChild>
								<a href="/">Return home</a>
							</Button>
						</div>
					</div>
				</div>
			</section>
		</main>
		<Footer />
	</body>
</html>
